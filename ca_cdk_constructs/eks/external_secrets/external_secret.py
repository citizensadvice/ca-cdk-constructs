from enum import Enum
from typing import Union

from cdk8s import ApiObjectMetadata
from constructs import Construct

from ca_cdk_constructs.eks.imports.io.external_secrets import (
    ExternalSecretV1Beta1,
    ExternalSecretV1Beta1Spec,
    ExternalSecretV1Beta1SpecSecretStoreRef,
    ExternalSecretV1Beta1SpecTarget,
    ExternalSecretV1Beta1SpecData,
    ExternalSecretV1Beta1SpecDataRemoteRef,
)


class ExternalSecretStore(Enum):
    """Known, existing ExternalSecret Stores, created by cluster admins and having predefined names"""

    VAULT = "vault"
    AWS_SSM = "aws-secrets-manager"
    AWS_PARAMETER_STORE = "aws-parameter-store"


class ExternalSecretSource:
    """
    Convenience class providing strongly typed way to collect external secret configurations.

    Usage:

        source1 = ExternalSecretSource(
            store=ExternalSecretStore.VAULT,
            k8s_secret_name="app-api-secret",
            source_secret="another/path",
            secret_mappings={"username": "FOO"},
        )
        source2 = ExternalSecretSource(
            store=ExternalSecretStore.AWS_SSM,
            k8s_secret_name="app-db-secret",
            source_secret="cdk-secret",
            secret_mappings={"prop": "VALUE"},
        )

        app = cdk8s.App()
        chart = cdk8s.Chart(app, "ExternalSecrets")

        ExternalSecret.from_external_secret_source(chart, "secret1", secret1)
        ExternalSecret.from_external_secret_source(chart, "secret2", secret2)

        cluster.add_cdk8s_chart("ExternalSecretsDeployment", chart)
    """

    def __init__(
        self,
        store: ExternalSecretStore,
        k8s_secret_name: str,
        source_secret: str,
        secret_mappings: dict[str, str],
        external_secret_name: str = None,
    ):
        """

        Args:
            k8s_secret_name (str): The name of the Kubernetes secret generated by ExternalSecrets
            source_secret (str): the name or id of the external secret source, e.g. Vault secret engine path or the name of a AWS Secrets Manager secret
            secret_mappings (dict[str, str]): Dictionary structure describing how to map the data in the external secret to env variables. The structure is:
                ``{ <secret key>: <env variable name> }``
            e.g.
                { "password": "DB_PASSWORD" }
            To use the secret key as env variable name, set the value to None or empty string e.g.
                ``{ "password": "" } # will set env var 'password'```
            external_secret_name: (str) Optional. The name of the external secret to be created. If not set the cdk will generate one
        """
        self._store = store
        self.k8s_secret_name = k8s_secret_name
        self.source_secret = source_secret
        self.secret_mappings = secret_mappings
        self.external_secret_name = external_secret_name

    @property
    def secret_store(self) -> ExternalSecretStore:
        return self._store


class ExternalSecret(Construct):
    """
    io.external_secrets.ExternalSecret facade which:
        - requires existing external secrets SecretStore(s), possibly created by a different workflow as explained in https://external-secrets.io/v0.6.1/overview/#roles-and-responsibilities
        - provides a simpler interface for creating known, supported ExternalSecret configurations, e.g. it does not support custom [templating](https://external-secrets.io/v0.7.0-rc1/guides/templating/)
        - always uses an ExternalSecrets API version that is compatible and supported in CA - managed clusters.
        - is restricted to only some supported SecretStores - `~ca_cdk_constructs.eks.external_secrets.ExternalSecretStore`

    Usage:

        ExternalSecret(self, "secret", secret_source=ExternalSecretSource(
                k8s_secret_name="app-secret",
                store=ExternalSecretStore.VAULT,
                source_secret="path/in/vault",
                secret_mappings={
                    "key_in_vault": "KEY_IN_K8S_SECRET",
                    "key_in_vault.subkey": "KEY_IN_K8S_SECRET2",
                    "key_in_vault2": "", # sets key in secret = key in external secret, i.e 'key_in_vault2'
                }
            )
        )

        ExternalSecret(self, "secret2", secret_source=ExternalSecretSource(
                k8s_secret_name="app-secret2",
                store=ExternalSecretStore.AWS_PARAMETER_STORE,
                source_secret="secret-1", # AWS parameter store parameter name
                secret_mappings={
                    "some_key": "KEY_IN_K8S_SECRET",
                    "some_key.subkey": "FOO",
                }
            )
        )
    """

    def __init__(
        self,
        scope: Construct,
        id: str,
        secret_source: ExternalSecretSource,
        metadata: Union[ApiObjectMetadata, dict] = {},
    ):
        super().__init__(scope, id)
        self._secret_source = secret_source

        ExternalSecretV1Beta1(
            self,
            "Resource",
            metadata=metadata,
            spec=ExternalSecretV1Beta1Spec(
                secret_store_ref=ExternalSecretV1Beta1SpecSecretStoreRef(
                    name=secret_source.secret_store.value,
                    kind="SecretStore",  # known, existing store
                ),
                refresh_interval="1h",
                target=ExternalSecretV1Beta1SpecTarget(name=secret_source.k8s_secret_name),
                data=[
                    ExternalSecretV1Beta1SpecData(
                        remote_ref=ExternalSecretV1Beta1SpecDataRemoteRef(
                            # the source ID, e.g. AWS SSM secret name or Vault path
                            key=secret_source.source_secret,
                            # which property to retrieve from provider
                            property=k,
                        ),
                        secret_key=v  # the key in the K8s secret e.g. the env var name
                        or str(k).split(".")[-1],
                        # if not specified, set the secret key = the last element of the pottentially . separated provider key
                    )
                    for k, v in secret_source.secret_mappings.items()
                ],
            ),
        )

    @property
    def k8s_secret_name(self) -> str:
        return self._secret_source.k8s_secret_name

    @property
    def source_secret(self) -> str:
        return self._secret_source.source_secret

    @property
    def secret_store(self) -> ExternalSecretStore:
        return self._secret_source.secret_store
